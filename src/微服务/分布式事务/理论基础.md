# 分布式事务-理论基础

## 事务的ACID原则

- 原子性（Atomicity）

  事务中的所有操作，要么全部成功，要么全部失败

- 一致性（Consistency）

  要保证数据库内部完整性约束、声明性约束，事务执行的前后都是合法的数据状态，事务的目的就是为了数据一致性

  如何实现事务的一致性：

  - 保证事务的原子性、持久性和隔离性

  - 数据库本身提供保障，完善其完整性约束

  - 应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的一致

- 隔离性（Isolation）

  事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰，对同一资源操作的事务不能同时发生

- 持久性（Durability）

  事务一旦提交，对数据库做的一切修改将永久保存，接下来的其他操作或故障不应该对其有任何影响

## CAP定理

CAP定理，也称为布鲁尔定理，是分布式系统理论中的一个基本定理，它指出在分布式计算系统中，无法同时满足以下三个特性：

- 一致性（Consistency）：所有节点在同一时间具有相同的数据视图，即在分布式系统中进行数据更新后，所有节点都能够读取到最新的数据
- 可用性（Availability）：系统能够对用户的请求做出响应，即使系统中的一部分节点出现故障或者失败，仍然可以保证整个系统的正常运行
- 分区容错性（Partition tolerance）：系统在面对网络分区（即节点间的通信中断）的情况下，仍能够保持正常运行

<img src="https://raw.githubusercontent.com/GIT-GAZZ/typora-cloud-image/master/image/image-20240125181407363-edaa81716c786fbdf98294c2ce2b054d.png" alt="image-20240125181407363" style="zoom: 30%;" />

在实际分布式系统中，分区是一定会发生的，当发生分区时，不同分区之间无法同步数据，当访问独立分区时，独立分区有两种处理方案：

- AP模式（高可用性，低一致性）：将自己的数据返回给客户端，但数据可能是错的，符合可用性指标，违背一致性指标
- CP模式（高一致性，低可用性）：等等正常分区同步数据给自己，符合一致性指标，违背可用性指标

## BASE理论

BASE理论是对CAP定理的一种解决思路，包含三个思想：

- 基本可用（Basically Available ）：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用
- 软状态（Soft State）：在一定时间内，允许出现中间状态，比如临时的不一致状态
- 最终一致性（Eventually Consistent）：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致

## 分布式事务

在分布式系统下，一个业务跨越多个服务或数据源，每个服务都是一个分支事务，要保证所有分支事务最终状态一致，这样的事务就是分布式事务

综上所述，分布式事务最大的问题是各个子事务的一致性问题，因此可以借鉴CAP定理和BASE理论：

- ==**AP模式（最终一致思想）**：各子事务分别执行和提交，允许出现结果不一致，处于**软状态**，然后采用弥补措施恢复数据即可（反向操作数据），实现**最终一致**==
- ==**CP模式（强一致思想）**：各个子事务执行后互相等待，同时提交，同时回滚，达成**强一致**。但事务等待过程中，处于**弱可用状态**==

实现机制：

- 全局事务：整个分布式事务
- 分支事务：分布式事务中包含的每个子系统的事务